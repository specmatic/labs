version: 3

components:
  sources:
    localSpecs:
      filesystem:
        directory: .

systemUnderTest:
  service:
    definitions:
      - definition:
          source:
            $ref: "#/components/sources/localSpecs"
          specs:
            - ./specs/product_search_bff_v6.yaml
    runOptions:
      openapi:
        type: test
        baseUrl: "{APP_URL:http://order-bff:8080}"
        filter: "PATH!='/health,/monitor/{id},/swagger'"
        actuatorUrl: "{APP_URL:http://order-bff:8080}/actuator/mappings"
    data:
      examples:
        - directories:
            - ./examples/bff
    settings:
      schemaResiliencyTests: all

dependencies:
  services:
    - service:
        definitions:
          - definition:
              source:
                $ref: "#/components/sources/localSpecs"
              specs:
                - ./specs/api_order_v5.yaml
        runOptions:
          openapi:
            type: mock
            baseUrl: "${ORDER_API_URL:http://localhost:8090}"
        data:
          examples:
            - directories:
                - ./examples/domain_service
    - service:
        definitions:
          - definition:
              source:
                $ref: "#/components/sources/localSpecs"
              specs:
                - ./specs/kafka.yaml
        runOptions:
          asyncapi:
            type: mock
            inMemoryBroker:
              host: "${KAFKA_BOOTSTRAP_SERVER_HOST:localhost}"
              port: 9092
            servers:
              - host: "${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}"
                protocol: kafka
  data:
    adapters:
      post_specmatic_response_processor: ./hooks/post_specmatic_response_processor.sh

specmatic:
  governance:
    successCriteria:
      minCoveragePercentage: 70
      maxMissedOperationsInSpec: 0
      enforce: true
  license:
    path: /specmatic/specmatic-license.txt
