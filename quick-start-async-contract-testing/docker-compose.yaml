services:
  broker:
    image: redpandadata/redpanda:v24.2.8
    container_name: quick-start-async-broker
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - "512M"
      - --reserve-memory
      - "0M"
      - --node-id
      - "0"
      - --check=false
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://broker:9092
    ports:
      - "9092:9092"
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy:.*true'"]
      interval: 3s
      timeout: 2s
      retries: 20
      start_period: 5s

  provider:
    container_name: quick-start-async-provider
    build:
      context: ./service
    depends_on:
      broker:
        condition: service_healthy
    environment:
      KAFKA_BOOTSTRAP_SERVER: broker:9092

  contract-test:
    container_name: quick-start-async-contract-test
    image: specmatic/enterprise:latest
    volumes:
      - ./:/usr/src/app
      - ../license.txt:/specmatic/specmatic-license.txt:ro
    depends_on:
      broker:
        condition: service_healthy
      provider:
        condition: service_started
    entrypoint: ["sh", "-lc"]
    command: ["sleep 6 && specmatic test"]

  studio:
    container_name: quick-start-async-studio
    image: specmatic/enterprise:latest
    profiles: ["studio"]
    volumes:
      - ./:/usr/src/app
      - ../license.txt:/specmatic/specmatic-license.txt:ro
    depends_on:
      broker:
        condition: service_healthy
      provider:
        condition: service_started
    command: ["studio"]
    ports:
      - "9000:9000"
